//Dependencies
var express = require('express'); // The main framework
var path = require('path'); // Used to merge paths efficiently
var bodyParser = require('body-parser'); //used to parse body of the request
var logger = require('morgan'); // used to log request url type and response code in the terminal
var cookieParser = require('cookie-parser')
var fs = require('fs')
var app = express();
var jwt = require('jsonwebtoken') ;
var fileUpload = require('express-fileupload');
//require controller
var initDb = require('./config/mongoInit.js').initDb ;
initDb() ;

superSecret = require('./config/config').key ;

//require routes
var loginHandler = require('./routes/loginHandler.js')
var signUpHandler = require('./routes/signUpHandler.js')
var add_data = require('./routes/add_data.js')
var get_data = require('./routes/get_data.js')
var remove_data = require('./routes/remove_data.js')
var chat_server = require('./routes/chat_server')

var http = require('http').Server(app);
var io = require('socket.io')(http) ;
//require middlewares

var authenticate = require('./middlewares/authenticate')


app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'ejs');
app.use(fileUpload());

app.use(logger('dev'));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: false }));
app.use(cookieParser())

// Static files provider for public directory
app.use(express.static(path.join(__dirname, 'public')))
/*
app.use(function(req, res, next){
  User.findOne({'name':'hutiya'}, function(err, user){
    console.log(user)
    console.log(err)
    res.end('Chutiya', user)
  })
})
*/
app.post('/decode_token',function(req, res, next){
  jwt.verify(req.body.token, superSecret, function(err, decoded){
    if(err){
      res.json({success:false, err:err})
    }else{
      res.json({success:true, decoded: decoded._doc})
    }
  })
})
//Routes
app.use('/login',loginHandler)
app.use('/signup',signUpHandler)
app.use(authenticate)

app.get('/:id', function(req, res, next){
  User.findOne({_id: req.params.id}, function(err, user){
    console.log(user) ;
    if(err){
      next();
    }else{
      if(user){
        res.render('profile',{user : user, logged_user: req.decoded._doc})
      }else{
        next()
      }
    }
  })
})
app.get('/:id/json', function(req, res, next){
  User.findOne({_id: req.params.id}, function(err, user){
    console.log(user) ;
    if(err){
      next();
    }else{
      if(user){
        res.json({user : user, logged_user: req.decoded._doc})
      }else{
        next()
      }
    }
  })
})
app.get('/:username', function(req, res, next){
  User.findOne({username: req.params.username}, function(err, user){
    if(err){
      next();
    }else{
      if(user){
        res.render('profile',{user : user, logged_user: req.decoded._doc})
      }else{
        next()
      }
    }
  })
})

app.get('/', function(req, res, next){
  res.redirect('/dashboard') ;
})
app.use('/add_data', add_data)
app.use('/get_data', get_data)
app.use('/remove_data', remove_data)
app.get('/dashboard', function(req, res, next){
  console.log(req.decoded) ;
  console.log(req.decoded._doc) ;
  User.findOne({_id: req.decoded._doc._id}, function(err, user){
    if(err){
      res.render('error',{ message:'We couldn\'t id you.'})
    }else{
      res.render('dashboard',{message:'', user: user})
    }
  })
})
// this error handler was generated by express-generator and for development environment only
app.get('/serve_image/:name', function(req, res, next){
  var image =  fs.readFileSync(__dirname+'/images/'+req.params.name)
  res.writeHead(200, {'Content-Type': 'image/'+ req.params.name.split('.')[1] });
     res.end(image, 'binary');
})

app.use('/chat',chat_server) ;
/*
//templates

app.use('/', function(req, res, next){})
app.use('/', )

*/
app.use(function(err, req, res, next) {
	console.log(err)
  // set locals, only providing error in development
  res.locals.message = err.message;
  res.locals.error = req.app.get('env') === 'development' ? err : {};

  // render the error page
  res.status(err.status || 500);
  res.end('error');
});

app.use(function(req,res){
  res.render('error', {message:''})
})

//io function handlers
io.on('connection', function(socket){
  //handler user during connections
  var cookiesParsed = socket.handshake.headers.cookie.replace('; ','=').replace('; ','=').split('=') ;
  var target = socket.handshake.headers.referer.split('/').pop();
  var indexOfUsername = cookiesParsed.indexOf('username') ;
  var username = cookiesParsed[indexOfUsername+1] ;
  Online.findOne({username:username}, function(err, user){
    if(err) console.log(err) ;
    var socket_to_be_saved = {
      socket_id: socket.id,
      target: target
    }
    if(user){
      console.log(socket_to_be_saved)
      user.socket_ids.push(socket_to_be_saved) ;
      user.save(function(err, onlineSaved){
        if(err) console.log(err) ;
      })
    }else{
      var online = new Online({
        username: username,
        socket_ids:[socket_to_be_saved]
      })
      online.save(function(err, onlineSaved){
        if(err) console.log(err) ;
      })
    }
  })
  //handle disconnections
  socket.on('disconnect', function(){
    console.log(username)
    Online.findOne({username: username}, function(err, user){
      if(user && user.socket_ids.length){
        var socket_index = findIndexOfSocketId(socket.id,user.socket_ids) ;
        user.socket_ids.splice(socket_index,1) ;
        user.save(function(err){
          if(err) console.log(err) ;
        }) ;
      }
    })
  })

  //private message saving

  socket.on('private message',function(data){
    var message = data.message ;
    var source = data.source ;
    var target = data.target ;
    Chat.findOne({participants:[source,target]}, function(err, chat_0){
      if(err){
        console.log(err) ;
      }else{
        if(chat_0){
          //insert message
          chat_0.messages.push({
            author: source,
            message: message,
            time: new Date()
          })
          chat_0.save(function(err, chat){
            if(err) console.log(err);
          })
        }else{
          Chat.findOne({participants:[target, source]}, function(err, chat_1){
              if(err){
                console.log(err)
              }else{
                if(chat_1){
                  //insert message
                  chat_1.messages.push({
                    author: source,
                    message: message,
                    time: new Date()
                  })
                  chat_1.save(function(err, chat){
                    if(err) console.log(err);
                  })
                }
              }
          })
        }
      }
    })


    //Live sending of messages

    Online.findOne({username:target}, function(err, user){
      if(err) console.log(err) ;
      if(user){
        console.log(user)
        if(user.socket_ids.length){
          for(var i=0;i<user.socket_ids.length;i++){
            if(user.socket_ids[i].target === data.source){
              socket.to(user.socket_ids[i].socket_id).emit('private message from_server', data);
            }else{
              console.log(data)
              console.log(user.socket_ids[i].target, data.source, 'Show me the diff')
            }
          }
        }
      }
    })

  })

  //typing or not typing
  socket.on('typing', function(data){
    if(data){
      var target = data.target ;
      var source = data.source ;
      Online.findOne({username: target}, function(err, user){
        if(user){
          for(var i=0;i<user.socket_ids.length;i++){
            if(user.socket_ids[i].target === source){
              socket.to(user.socket_ids[i].socket_id).emit('typing echo', data);
              console.log('sent 5465') ;
            }else{
              console.log(data) ;
            }
          }
        }
      })
    }
  })

  //not typing
/*  socket.on('not typing', function(data){
    if(data){
      var target = data.target ;
      var source = data.source ;
      Online.findOne({username: target}, function(err, user){
        for(var i=0;i<user.socket_ids.length;i++){
          if(user.socket_ids[i].target === source){
            socket.to(user.socket_ids[i].socket_id).emit('not typing echo1', data);
            console.log('Emitted!') ;
          }else{
            console.log(data,'Crap bro') ;
          }
        }
      })
    }
  })
*/
})


http.listen(3000) ;

function findIndexOf(username, array){
  for(var i=0;i< array.length ;i++){
    if( username === array[i].username){
      return i ;
    }
  }
  return -1 ;
}
function findIndexOfSocketId(id, array){
  for(var i=0;i< array.length ;i++){
    if( id === array[i].socket_id){
      return i ;
    }
  }
  return -1 ;
}

/*

Saving Chat

Chat.findOne({participants:[p1,p2]}, function(err, chat_0){
  if(chat_0){
    //insert message
    chat_0.messages.push({
      author: p1,
      message: message_text,
      time: new Date()
    })
    chat_0.save(function(err, chat){
      if(err) console.log(err);
    })
  }else{
    Chat.findOne({participants:[p2,p1]}, function(err, chat_1){
        if(err){
          console.log(err)
        }else{
          if(chat_1){
            //insert message
            chat_1.messages.push({
              author: host,
              message: message_text,
              time: new Date()
            })
            chat_1.save(function(err, chat){
              if(err) return;
            })
          }
        }
    })
  }
})

*/

/*
if(user.socket_ids.indexOf(socket.id) != (-1)){
  user.socket_ids.splice(user.socket_ids.indexOf(socket.id),1) ;
  user.save(function(err){
    if(err) console.log(err) ;
  })
}

*/
